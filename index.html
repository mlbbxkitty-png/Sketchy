<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Draw</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111">

<style>
html,body{
  margin:0;
  background:#111;
  overflow:hidden;
  touch-action:none;
}

#topbar{
  height:48px;
  background:#1b1b1b;
  display:flex;
  align-items:center;
  padding:4px;
  gap:6px;
}

#topbar button,input{
  height:40px;
  background:#2a2a2a;
  color:white;
  border:none;
  border-radius:6px;
}

#stage{
  position:absolute;
  top:48px;
  left:0;
  right:0;
  bottom:0;
  overflow:hidden;
}

canvas{
  position:absolute;
  left:0;
  top:0;
  background:#fff;
}
</style>
</head>

<body>

<div id="topbar">
  <button id="brush">‚úèÔ∏è</button>
  <button id="eraser">üßΩ</button>
  <button id="move">‚úã</button>
  <button id="undo">‚Ü∂</button>
  <button id="redo">‚Ü∑</button>
  <input type="color" id="color" value="#000000">
  <input type="range" id="size" min="1" max="30" value="6">
</div>

<div id="stage"></div>

<script>
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}

// ---------- LAYERS ----------
const stage=document.getElementById("stage");
const layers=[];
let activeLayer=0;

function newLayer(){
  const c=document.createElement("canvas");
  c.width=window.innerWidth;
  c.height=window.innerHeight-48;
  stage.appendChild(c);
  layers.push(c);
  activeLayer=layers.length-1;
}
newLayer();

// ---------- VIEW TRANSFORM ----------
let scale=1,offX=0,offY=0;

// ---------- TOOL STATE ----------
let tool="brush";
brush.onclick=()=>tool="brush";
eraser.onclick=()=>tool="eraser";
move.onclick=()=>tool="move";

// ---------- UNDO ----------
const history=[],redoStack=[];
function snapshot(){
  history.push(layers.map(c=>c.toDataURL()));
  redoStack.length=0;
}
undo.onclick=()=>{
  if(!history.length)return;
  redoStack.push(layers.map(c=>c.toDataURL()));
  restore(history.pop());
};
redo.onclick=()=>{
  if(!redoStack.length)return;
  history.push(layers.map(c=>c.toDataURL()));
  restore(redoStack.pop());
};

function restore(state){
  state.forEach((d,i)=>{
    const img=new Image();
    img.onload=()=>layers[i].getContext("2d").drawImage(img,0,0);
    img.src=d;
  });
}

// ---------- DRAW ----------
let draw=false,lastX,lastY;
let pointers=[];

stage.addEventListener("pointerdown",e=>{
  pointers.push(e);
  if(pointers.length===1 && tool!=="move"){
    snapshot();
    draw=true;
    lastX=(e.clientX-offX)/scale;
    lastY=(e.clientY-48-offY)/scale;
  }
});

stage.addEventListener("pointermove",e=>{
  pointers=pointers.map(p=>p.pointerId===e.pointerId?e:p);

  if(tool==="move" && pointers.length===2){
    const dx=pointers[0].clientX-pointers[1].clientX;
    const dy=pointers[0].clientY-pointers[1].clientY;
    scale=Math.min(4,Math.max(0.5,Math.abs(dx)/200));
    return;
  }

  if(!draw)return;

  const ctx=layers[activeLayer].getContext("2d");
  const x=(e.clientX-offX)/scale;
  const y=(e.clientY-48-offY)/scale;

  ctx.lineCap="round";
  ctx.lineWidth=size.value*(e.pressure||0.5);
  ctx.strokeStyle=color.value;
  ctx.globalCompositeOperation=tool==="eraser"?"destination-out":"source-over";

  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(x,y);
  ctx.stroke();

  lastX=x; lastY=y;
});

stage.addEventListener("pointerup",e=>{
  pointers=pointers.filter(p=>p.pointerId!==e.pointerId);
  draw=false;
});

// ---------- APPLY TRANSFORM ----------
function update(){
  layers.forEach(c=>{
    c.style.transform=
      `translate(${offX}px,${offY}px) scale(${scale})`;
  });
  requestAnimationFrame(update);
}
update();
</script>

</body>
  </html>
  
